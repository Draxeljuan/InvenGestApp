<div class="sidebar">
  <div class="logo">
    <h2>InvenGest Admin</h2>
  </div>
  <nav class="menu">
    <div class="menu-item" routerLink="/dashboard" routerLinkActive="active">
            <span>ğŸ“Š Dashboard</span>
        </div>
    <div class="menu-item" routerLink="/inventario" routerLinkActive="active">
      <span>ğŸ“¦ Inventario</span>
    </div>
    <div
      class="menu-item"
      routerLink="/movimientos-inventario"
      routerLinkActive="active"
    >
      <span>ğŸ”„ Mov. Inventario</span>
    </div>
    <div class="menu-item" routerLink="/reportes" routerLinkActive="active">
      <span>ğŸ“Š Reportes</span>
    </div>
    <div class="menu-item" routerLink="/ventas" routerLinkActive="active">
      <span>ğŸ’° Ventas</span>
    </div>
    <div
      class="menu-item"
      routerLink="/historial-ventas"
      routerLinkActive="active"
    >
      <span>ğŸ“œ Historial Ventas</span>
    </div>
    <div
      class="menu-item"
      routerLink="/admin-dashboard"
      routerLinkActive="active"
    >
      <span>ğŸ” Buscar Producto</span>
    </div>
    <div class="menu-item" routerLink="/alertas" routerLinkActive="active">
      <span>ğŸ”” Alertas</span>
    </div>
    <div class="menu-item" routerLink="/perfil" routerLinkActive="active">
      <span>ğŸ‘¤ Perfil</span>
    </div>
    <div class="menu-item logout-btn" (click)="logoutService.openModal()">
      <span>ğŸ“¤ Cerrar sesiÃ³n</span>
    </div>
  </nav>
</div>

<div class="main-content">
  <div class="header">
    <h1>Nueva Venta</h1>
  </div>

  <!-- SecciÃ³n de informaciÃ³n del cliente -->
  <div class="customer-info">
    <h2 class="cart-title">InformaciÃ³n del Cliente</h2>

    <!-- BÃºsqueda de clientes -->
    <div class="search-form">
      <input
        type="text"
        [(ngModel)]="terminoBusquedaCliente"
        required
        pattern="^[a-zA-ZÃ¡Ã©Ã­Ã³ÃºÃÃ‰ÃÃ“ÃšÃ±Ã‘\s]+$"
        placeholder="Buscar por nombre o apellido..."
        maxlength="50"
        (input)="validarYBuscarCliente()"
        #busquedaInput="ngModel"
        name="busquedaCliente"
      />
      <button (click)="validarYBuscarCliente()">Buscar</button>

      <div *ngIf="busquedaInput.invalid && busquedaInput.touched">
        <small *ngIf="busquedaInput.errors?.['pattern']" class="error-msg">
          âš  Ingresa texto vÃ¡lido. No se permiten nÃºmeros ni caracteres
          especiales.
        </small>
        <small *ngIf="busquedaInput.errors?.['required']" class="error-msg">
          âš  Este campo es obligatorio.
        </small>
      </div>
    </div>

    <!-- Resultados de la bÃºsqueda -->
    <div class="search-results" *ngIf="clientesFiltrados.length > 0">
      <p>Clientes encontrados:</p>
      <ul class="scrollable-list">
        <li
          *ngFor="let cliente of clientesFiltrados"
          [ngClass]="{
            'selected-product':
              cliente.idCliente === clienteSeleccionado?.idCliente
          }"
          (click)="seleccionarCliente(cliente)"
        >
          {{ cliente.primerNombre }} {{ cliente.primerApellido }}
        </li>
      </ul>
    </div>

    <!-- OpciÃ³n para crear cliente si no hay resultados -->
    <!-- SecciÃ³n cuando no hay clientes -->
    <div
      *ngIf="
        clientesFiltrados.length === 0 &&
        terminoBusquedaCliente.trim().length >= 3
      "
      class="no-clientes"
    >
      <p>No se encontraron clientes.</p>
      <button
        class="crear-cliente-nuevo"
        (click)="mostrarFormularioNuevoCliente()"
      >
        Crear Cliente Nuevo
      </button>
    </div>

    <!-- Formulario para registrar un nuevo cliente -->
    <div *ngIf="mostrarFormularioCliente" class="formulario-cliente">
      <h3>Registrar Nuevo Cliente</h3>

      <label>Nombre:</label>
      <input
        type="text"
        [(ngModel)]="nuevoCliente.primerNombre"
        name="nombreCliente"
        maxlength="30"
        pattern="^[a-zA-ZÃ¡Ã©Ã­Ã³ÃºÃÃ‰ÃÃ“ÃšÃ±Ã‘\s]+$"
        required
        #nombreCliente="ngModel"
      />
      <div *ngIf="nombreCliente.invalid && nombreCliente.touched">
        <small *ngIf="nombreCliente.errors?.['pattern']" class="error-msg">
          âš  Solo se permiten letras y espacios.
        </small>
        <small *ngIf="nombreCliente.errors?.['required']" class="error-msg">
          âš  Este campo es obligatorio.
        </small>
      </div>

      <label>Apellido:</label>
      <input
        type="text"
        [(ngModel)]="nuevoCliente.primerApellido"
        name="apellidoCliente"
        maxlength="30"
        pattern="^[a-zA-ZÃ¡Ã©Ã­Ã³ÃºÃÃ‰ÃÃ“ÃšÃ±Ã‘\s]+$"
        required
        #apellidoCliente="ngModel"
      />
      <div *ngIf="apellidoCliente.invalid && apellidoCliente.touched">
        <small *ngIf="apellidoCliente.errors?.['pattern']" class="error-msg">
          âš  Solo se permiten letras y espacios.
        </small>
        <small *ngIf="apellidoCliente.errors?.['required']" class="error-msg">
          âš  Este campo es obligatorio.
        </small>
      </div>

      <button
        (click)="registrarCliente()"
        [disabled]="nombreCliente.invalid || apellidoCliente.invalid"
      >
        Registrar
      </button>
    </div>

    <!-- InformaciÃ³n del cliente seleccionado -->
    <div *ngIf="clienteSeleccionado" class="selected-client">
      <h3>Cliente seleccionado:</h3>
      <p><strong>ID:</strong> {{ clienteSeleccionado.idCliente }}</p>
      <p>
        <strong>Nombre:</strong> {{ clienteSeleccionado.primerNombre }}
        {{ clienteSeleccionado.primerApellido }}
      </p>
    </div>
  </div>

  <!-- AquÃ­ irÃ¡n mÃ¡s contenidos especÃ­ficos -->

  <div class="sales-container">
    <div class="product-search">
      <h2 class="cart-title">Buscar Productos</h2>

      <!-- Barra de bÃºsqueda -->
      <div class="search-form">
        <input
          type="text"
          [(ngModel)]="terminoBusquedaProducto"
          name="busquedaProducto"
          placeholder="Buscar por nombre o ID..."
          maxlength="30"
          pattern="^[a-zA-Z0-9Ã¡Ã©Ã­Ã³ÃºÃÃ‰ÃÃ“ÃšÃ±Ã‘\s]*$"
          required
          #busquedaProductoInput="ngModel"
          (input)="buscarProducto()"
        />
        <button
          (click)="buscarProducto()"
          [disabled]="busquedaProductoInput.invalid"
        >
          Buscar
        </button>

        <div
          *ngIf="busquedaProductoInput.invalid && busquedaProductoInput.touched"
        >
          <small
            *ngIf="busquedaProductoInput.errors?.['pattern']"
            class="error-msg"
          >
            âš  Solo se permiten letras y nÃºmeros.
          </small>
          <small
            *ngIf="busquedaProductoInput.errors?.['required']"
            class="error-msg"
          >
            âš  Este campo es obligatorio.
          </small>
        </div>
      </div>

      <!-- Resultados de bÃºsqueda -->
      <div class="search-results" *ngIf="productosFiltrados.length > 0">
        <p>Productos encontrados:</p>
        <ul class="scrollable-list">
          <li
            *ngFor="let producto of productosFiltrados"
            (click)="agregarAlCarrito(producto)"
          >
            <strong>{{ producto.nombre }}</strong> (ID:
            {{ producto.idProducto }}) - ${{ producto.precioVenta }} | Stock:
            {{ producto.stock }}
          </li>
        </ul>
      </div>
    </div>

    <!-- Carrito de compras -->
    <div class="cart-summary">
      <h2 class="cart-title">Carrito de Compras</h2>

      <div class="cart-items">
        <div class="cart-item" *ngFor="let item of carrito">
          <div>
            <div>
              <strong>{{ item.nombre }}</strong>
            </div>
            <div>${{ item.precioVenta }}</div>
          </div>
          <div class="item-controls">
            <button class="qty-btn" (click)="cambiarCantidad(item, -1)">
              -
            </button>
            <span>{{ item.cantidad }}</span>
            <button class="qty-btn" (click)="cambiarCantidad(item, 1)">
              +
            </button>
            <button class="remove-btn" (click)="removerDelCarrito(item)">
              X
            </button>
          </div>
        </div>
      </div>

      <div class="cart-summary-line">
        <span>Total:</span>
        <span>${{ calcularSubtotal() }}</span>
        <!-- Total ahora es igual al subtotal -->
      </div>

      <button
        class="checkout-btn"
        (click)="confirmarVenta()"
        [disabled]="!clienteSeleccionado || carrito.length === 0"
      >
        Finalizar Venta
      </button>
    </div>

    <!-- Modal de factura -->
    <div class="modal" *ngIf="mostrarModalFactura">
      <div class="modal-content">
        <h2>Venta procesada exitosamente</h2>
        <p>Â¿Deseas descargar la factura?</p>
        <div class="modal-actions">
          <button class="confirm-btn" (click)="descargarFactura()">
            SÃ­, descargar
          </button>
          <button class="cancel-btn" (click)="cerrarModal()">No, cerrar</button>
        </div>
      </div>
    </div>

    <div class="sale-history">
      <h2 class="cart-title">Ventas Recientes</h2>
      <table class="inventory-table" style="width: 100%">
        <thead>
          <tr>
            <th>ID Venta</th>
            <th>Fecha</th>
            <th>Total</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let venta of ventas">
            <td>{{ venta.idVenta }}</td>
            <td>{{ venta.fecha }}</td>
            <td>${{ venta.total }}</td>
            <td>Completada</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
